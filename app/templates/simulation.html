<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <style>
        .board-grid {
            /* Các thuộc tính sẽ được đặt qua JS dựa trên kích thước board */
            display: grid;
            gap: 4px;
        }
        .block {
            width: 100%;
            height: 80px; /* Chiều cao cố định */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: black;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            transform-origin: center center;
        }
        .highlight {
            background-color: #f59e0b !important; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-100 p-8 min-h-screen">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Mô phỏng Luật Chơi Xoay Khối</h1>
        <div id="status" class="mb-4 text-center text-red-600 font-medium hidden"></div>

        <div class="mb-8 p-4 border rounded-lg bg-gray-50">
            <h3 class="text-xl font-semibold mb-3 text-indigo-700">Thông tin Ván đấu</h3>
            <form id="simulation-form" class="space-y-4">
                <div>
                    <label for="starts-at" class="block text-sm font-medium text-gray-700">Question ID (startsAt)</label>
                    <input type="number" id="starts-at" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 1700000000" required>
                </div>
                <div>
                    <label for="json-answer" class="block text-sm font-medium text-gray-700">JSON Answer (Ops: x, y, n)</label>
                    <textarea id="json-answer" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder='{"ops": [{"x": 0, "y": 0, "n": 2}, {"x": 1, "y": 1, "n": 3}]}' required></textarea>
                </div>
                <button type="submit" id="run-button" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Chạy Mô Phỏng
                </button>
            </form>
        </div>
        
        <div class="text-center mb-4">
            <h2 id="current-step" class="text-xl font-semibold text-gray-800">Board ban đầu</h2>
            <p id="pair-count-display" class="text-sm text-green-600 font-medium">Pairs: N/A</p>
        </div>
        <div id="game-board-container" class="mx-auto flex justify-center">
            <div id="game-board" class="board-grid border-4 border-gray-700 p-2 rounded-lg" style="max-width: 500px;">
                <p id="initial-load-msg" class="text-gray-500 p-4">Nhập Question ID và chạy mô phỏng để tải board.</p>
            </div>
        </div>

    </div>

    <script>
        const form = document.getElementById('simulation-form');
        const startsAtInput = document.getElementById('starts-at');
        const jsonAnswerInput = document.getElementById('json-answer');
        const statusDiv = document.getElementById('status');
        const runButton = document.getElementById('run-button');
        const boardElement = document.getElementById('game-board');
        const currentStepDisplay = document.getElementById('current-step');
        const pairCountDisplay = document.getElementById('pair-count-display');
        const initialLoadMsg = document.getElementById('initial-load-msg');

        let currentBoardState = []; // Lưu trữ trạng thái board hiện tại (giá trị)
        let boardSize = 0;

        /**
         * Render hoặc cập nhật board DOM từ dữ liệu 2D array.
         * @param {Array<Array<number>>} boardData 
         * @param {string | null} highlightClass Class CSS để highlight các khối liên quan
         */
        function renderBoard(boardData, targetElement) {
            targetElement.innerHTML = '';
            boardSize = boardData.length;
            targetElement.style.gridTemplateColumns = `repeat(${boardSize}, 1fr)`;
            targetElement.style.gridTemplateRows = `repeat(${boardSize}, 1fr)`;

            for (let x = 0; x < boardSize; x++) {
                for (let y = 0; y < boardSize; y++) {
                    const value = boardData[x][y];
                    const div = document.createElement('div');
                    div.className = 'block bg-blue-600 border border-blue-800 transition duration-300';
                    div.id = `block-${x}-${y}`;
                    div.style.gridRow = x + 1;
                    div.style.gridColumn = y + 1;
                    div.textContent = value;
                    targetElement.appendChild(div);
                }
            }
            currentBoardState = boardData;
            initialLoadMsg.classList.add('hidden');
        }

        /**
         * Chạy animation xoay khối con (k x k).
         * Đây là logic đơn giản hóa cho animation xoay 90 độ, sau đó cập nhật giá trị.
         * Logic xoay thực tế (hoán đổi vị trí DOM) phức tạp hơn nhiều.
         * @param {Array<Object>} steps 
         */
        async function runSteps(steps) {
            // Bước 0: Hiển thị trạng thái ban đầu
            renderBoard(steps[0].board, boardElement);
            currentStepDisplay.textContent = "Bước 0: Board ban đầu";
            pairCountDisplay.textContent = `Pairs: ${steps[0].pair_count_after || 'N/A'}`;
            await new Promise(resolve => setTimeout(resolve, 1000)); 

            for (let i = 1; i < steps.length; i++) {
                const step = steps[i];
                const op = step.op;
                
                currentStepDisplay.textContent = `Bước ${step.step}: Xoay ${op.n}x${op.n} tại (${op.x}, ${op.y})`;
                pairCountDisplay.textContent = `Pairs: ${step.pair_count_after}`;
                
                const targetBlocks = [];

                // Lấy các khối con cần xoay và highlight chúng
                for (let x = 0; x < op.n; x++) {
                    for (let y = 0; y < op.n; y++) {
                        const block = document.getElementById(`block-${op.x + x}-${op.y + y}`);
                        if (block) {
                            targetBlocks.push(block);
                            block.classList.add('highlight');
                        }
                    }
                }
                
                // --- Animation Xoay (Anime.js) ---
                await new Promise(resolve => {
                    anime({
                        targets: targetBlocks,
                        rotate: '90deg', // Góc xoay
                        duration: 700,
                        easing: 'easeInOutQuad',
                        // delay: anime.stagger(50),
                        complete: function() {
                            // 1. Reset góc xoay
                            targetBlocks.forEach(el => {
                                el.style.transform = 'rotate(0deg)';
                                el.classList.remove('highlight');
                            });
                            
                            // 2. CẬP NHẬT TRẠNG THÁI BOARD VÀ GIÁ TRỊ (RERENDER)
                            renderBoard(step.board, boardElement);

                            resolve();
                        }
                    });
                });
                
                // Chờ giữa các bước
                await new Promise(resolve => setTimeout(resolve, 800)); 
            }
            statusDiv.textContent = "Mô phỏng hoàn tất! (Vui lòng kiểm tra lại pairs cuối cùng)";
            statusDiv.classList.remove('text-red-600');
            statusDiv.classList.add('text-green-600');
        }


        // --- XỬ LÝ FORM SUBMIT ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            runButton.disabled = true;
            runButton.textContent = 'Đang chạy Simulation...';
            statusDiv.textContent = '';
            statusDiv.classList.add('hidden');

            try {
                const startsAt = parseInt(startsAtInput.value);
                const opsData = JSON.parse(jsonAnswerInput.value);
                
                if (isNaN(startsAt)) throw new Error("Question ID (startsAt) không hợp lệ.");
                if (!Array.isArray(opsData.ops)) throw new Error("Ops phải là một danh sách.");

                const payload = {
                    starts_at: startsAt,
                    ops: opsData.ops
                };

                const response = await fetch('/simulation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (!response.ok) {
                    statusDiv.textContent = `LỖI API: ${result.detail || 'Không xác định.'}`;
                    statusDiv.classList.remove('hidden');
                    statusDiv.classList.add('text-red-600');
                    return;
                }

                if (result.status === 'success' && result.simulation_steps && result.simulation_steps.length > 0) {
                    // Bắt đầu chạy animation
                    await runSteps(result.simulation_steps);
                } else {
                    statusDiv.textContent = 'Không có bước mô phỏng nào được trả về. Kiểm tra lại dữ liệu Problem.';
                    statusDiv.classList.remove('hidden');
                }

            } catch (error) {
                statusDiv.textContent = `LỖI: ${error.message}. Vui lòng kiểm tra định dạng JSON và ID.`;
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('text-red-600');
                console.error('Simulation Error:', error);
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Chạy Mô Phỏng';
            }
        });
    </script>
</body>
</html>